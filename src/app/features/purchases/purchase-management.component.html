<mat-toolbar color="primary" class="page-toolbar">
  <div class="toolbar-content">
    <div class="title-group">
      <h1>Gestión de compras</h1>
      <p class="subtitle">Monitorea órdenes, recepciones y pagos desde un solo lugar.</p>
    </div>

    <div class="toolbar-actions">
      <button mat-stroked-button color="primary" (click)="refresh()" [disabled]="loading()">
        <mat-icon>refresh</mat-icon>
        Actualizar
      </button>
      <button mat-flat-button color="accent">
        <mat-icon>add</mat-icon>
        Nueva orden
      </button>
    </div>
  </div>
</mat-toolbar>

<mat-progress-bar *ngIf="loading()" mode="indeterminate"></mat-progress-bar>

<div class="page-grid" [class.loading]="loading()">
  <!-- Sidebar: métricas + filtros -->
  <aside class="sidebar">
    <mat-card
      class="summary-card"
      *ngFor="let card of summaryCards(); trackBy: trackBySummary"
      appearance="outlined"
    >
      <div class="summary-icon" [ngClass]="card.tone">
        <mat-icon>{{ card.icon }}</mat-icon>
      </div>
      <div>
        <p class="summary-label">{{ card.label }}</p>
        <p class="summary-value">{{ card.value }}</p>
        <p class="summary-helper" *ngIf="card.helper">{{ card.helper }}</p>
      </div>
    </mat-card>

    <mat-card class="filters-card" appearance="outlined">
      <div class="card-header">
        <h2>Filtrar compras</h2>
        <button mat-button type="button" (click)="clearFilters()">
          <mat-icon>filter_alt_off</mat-icon>
          Limpiar
        </button>
      </div>

      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Buscar</mat-label>
        <mat-icon matPrefix>search</mat-icon>
        <input
          matInput
          placeholder="Folio, proveedor o ID"
          [ngModel]="search()"
          (ngModelChange)="search.set($event)"
        />
      </mat-form-field>

      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Estado</mat-label>
        <mat-select [ngModel]="statusFilter()" (ngModelChange)="statusFilter.set($event)">
          <mat-option *ngFor="let option of statusOptions" [value]="option.value">
            {{ option.label }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Proveedor</mat-label>
        <mat-select [ngModel]="supplierFilter()" (ngModelChange)="supplierFilter.set($event)">
          <mat-option value="todos">Todos los proveedores</mat-option>
          <mat-option *ngFor="let supplier of suppliers()" [value]="supplier">
            {{ supplierLabel(supplier) }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Periodo</mat-label>
        <mat-select [ngModel]="periodFilter()" (ngModelChange)="periodFilter.set($event)">
          <mat-option *ngFor="let option of periodOptions" [value]="option.value">
            {{ option.label }}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </mat-card>
  </aside>

  <!-- Lista de compras -->
  <section class="purchases-list">
    <mat-card class="list-card" appearance="outlined">
      <div class="card-header">
        <h2>Órdenes de compra</h2>
        <span class="helper">
          {{ filtered().length }} {{ filtered().length === 1 ? 'orden' : 'órdenes' }} visibles
        </span>
      </div>

      <div class="list-wrapper" *ngIf="filtered().length; else purchasesEmpty">
        <article
          class="purchase-row"
          *ngFor="let purchase of filtered(); trackBy: trackByPurchase"
          [class.active]="selected()?.id === purchase.id"
          (click)="selectPurchase(purchase)"
          tabindex="0"
          (keyup.enter)="selectPurchase(purchase)"
        >
          <div class="row-main">
            <div class="row-title">
              <h3>{{ purchase.folio }}</h3>
              <mat-chip [ngClass]="getStatusClass(purchase.estado)">
                {{ getStatusLabel(purchase.estado) }}
              </mat-chip>
            </div>
            <p class="row-subtitle">{{ purchase.proveedor }} • {{ purchase.warehouse }}</p>
            <p class="row-date">Solicitado el {{ purchase.fecha | date : 'mediumDate' }}</p>
          </div>

          <div class="row-stats">
            <div>
              <span class="label">Total</span>
              <span class="value">{{ formatCurrency(purchase.total, purchase.moneda) }}</span>
            </div>
            <div>
              <span class="label">Recibido</span>
              <span class="value">{{ getReceivedPercentage(purchase) }}%</span>
            </div>
            <div>
              <span class="label">Pago</span>
              <span class="value">{{ getPaymentLabel(purchase.pagoEstado) }}</span>
            </div>
          </div>
        </article>
      </div>
    </mat-card>
  </section>

  <!-- Detalle de la compra seleccionada -->
  <section class="purchase-detail" *ngIf="selected(); else noSelection">
    <mat-card appearance="outlined">
      <div class="detail-header">
        <div>
          <h2>Orden {{ selected()?.folio }}</h2>
          <p class="detail-subtitle">{{ selected()?.proveedor }}</p>
          <p class="detail-date">Emitida el {{ selected()?.fecha | date : 'medium' }}</p>
        </div>
        <mat-chip-set class="status-chips">
          <mat-chip [ngClass]="getStatusClass(selected()!.estado)">
            {{ getStatusLabel(selected()!.estado) }}
          </mat-chip>
          <mat-chip [ngClass]="getPaymentClass(selected()!.pagoEstado)">
            {{ getPaymentLabel(selected()!.pagoEstado) }}
          </mat-chip>
        </mat-chip-set>
      </div>

      <div class="detail-meta">
        <div>
          <span class="label">Folio</span>
          <span class="value mono">{{ selected()?.folio }}</span>
        </div>
        <div>
          <span class="label">Almacén</span>
          <span class="value">{{ selected()?.warehouse }}</span>
        </div>
        <div>
          <span class="label">Total</span>
          <span class="value">{{ formatCurrency(selected()!.total, selected()!.moneda) }}</span>
        </div>
        <div>
          <span class="label">Llegada estimada</span>
          <span class="value warning" *ngIf="selected()?.llegadaEstimada; else sinFecha">
            {{ selected()?.llegadaEstimada | date : 'mediumDate' }}
          </span>
        </div>
        <div>
          <span class="label">Creada por</span>
          <span class="value">{{ selected()?.createdBy }}</span>
        </div>
        <div>
          <span class="label">Actualizada</span>
          <span class="value">{{ selected()?.updatedAt | date : 'medium' }}</span>
        </div>
      </div>

      <ng-template #sinFecha>
        <span class="value">Sin fecha estimada</span>
      </ng-template>

      <div class="detail-actions" *ngIf="nextStatuses().length">
        <span class="label">Actualizar estado</span>
        <div class="actions">
          <button
            mat-stroked-button
            color="primary"
            type="button"
            *ngFor="let status of nextStatuses()"
            (click)="updateStatus(status)"
          >
            {{ getStatusLabel(status) }}
          </button>
        </div>
      </div>

      <section class="items-section">
        <div class="section-header">
          <h3>Artículos solicitados</h3>
          <span>{{ selected()?.items?.length }} ítems</span>
        </div>

        <div class="items-table" *ngIf="selected()?.items?.length; else noItems">
          <div class="items-header">
            <span>SKU</span>
            <span>Descripción</span>
            <span class="numeric">Cantidad</span>
            <span class="numeric">Recibido</span>
            <span class="numeric">Pendiente</span>
            <span class="numeric">Total</span>
          </div>

          <div
            class="items-row"
            *ngFor="let item of selected()!.items; trackBy: trackByItem"
          >
            <span class="mono">{{ item.sku }}</span>
            <div class="description">
              <p>{{ item.nombre }}</p>
              <small>{{ item.categoria }}</small>
              <div class="progress">
                <mat-progress-bar
                  mode="determinate"
                  [value]="item.cantidad ? (item.recibido / item.cantidad) * 100 : 0"
                ></mat-progress-bar>
                <small>{{ item.recibido }} de {{ item.cantidad }} unidades</small>
              </div>
            </div>
            <span class="numeric">{{ item.cantidad }}</span>
            <span class="numeric">{{ item.recibido }}</span>
            <span class="numeric" [class.warning]="getPendingUnits(item) > 0">
              {{ getPendingUnits(item) }}
            </span>
            <span class="numeric">
              {{ formatCurrency(getItemTotal(item), selected()!.moneda) }}
            </span>
          </div>
        </div>
      </section>

      <section class="timeline-section" *ngIf="selected()?.timeline?.length">
        <div class="section-header">
          <h3>Línea de tiempo</h3>
        </div>
        <mat-list>
          <mat-list-item *ngFor="let step of selected()!.timeline; trackBy: trackByTimeline">
            <mat-icon matListItemIcon class="timeline-icon">check_circle</mat-icon>
            <div matListItemTitle>{{ getStatusLabel(step.estado) }}</div>
            <div matListItemLine class="timeline-note">
              {{ step.fecha | date : 'medium' }}
              <ng-container *ngIf="step.descripcion">• {{ step.descripcion }}</ng-container>
            </div>
          </mat-list-item>
        </mat-list>
      </section>

      <section class="documents-section" *ngIf="selected()?.documentos?.length">
        <div class="section-header">
          <h3>Documentos</h3>
          <span>{{ selected()!.documentos!.length }} archivos</span>
        </div>
        <ul>
          <li *ngFor="let doc of selected()!.documentos">
            <mat-icon>description</mat-icon>
            {{ doc.referencia }}
          </li>
        </ul>
      </section>

      <section class="notes-section" *ngIf="selected()?.notas">
        <div class="section-header">
          <h3>Notas</h3>
        </div>
        <p class="detail-note">{{ selected()?.notas }}</p>
      </section>
    </mat-card>
  </section>
</div>

<ng-template #noItems>
  <div class="empty-state">
    <mat-icon>inventory_2</mat-icon>
    <p>Esta orden aún no tiene artículos registrados.</p>
  </div>
</ng-template>

<ng-template #purchasesEmpty>
  <div class="empty-state">
    <mat-icon>inventory</mat-icon>
    <p>No hay compras que coincidan con los filtros seleccionados.</p>
    <button mat-stroked-button color="primary" type="button" (click)="clearFilters()">
      Limpiar filtros
    </button>
  </div>
</ng-template>

<ng-template #noSelection>
  <section class="purchase-detail">
    <mat-card class="empty-state" appearance="outlined">
      <mat-icon>assignment</mat-icon>
      <p>Selecciona una orden para ver los detalles.</p>
    </mat-card>
  </section>
</ng-template>

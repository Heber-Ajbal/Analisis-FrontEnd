<div class="max-w-6xl mx-auto px-4 py-6 space-y-6">
  <!-- ================== CARRITO NORMAL ================== -->
  <ng-container *ngIf="!showPaymentForm">
    <header class="flex flex-col gap-2 sm:flex-row sm:items-end sm:justify-between">
      <div>
        <p class="text-sm uppercase tracking-wide text-blue-600 font-semibold">Carrito de compras</p>
        <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">Revisa los repuestos antes de pagar</h1>
        <p class="text-sm text-gray-500 mt-1">
          Gestiona cantidades, selecciona el método de envío y aplica cupones promocionales.
        </p>
      </div>
      <div class="flex gap-3">
        <button
          mat-stroked-button
          color="primary"
          class="h-10"
          (click)="clearCart()"
          [disabled]="!cartItems.length"
        >
          <mat-icon class="!mr-2">delete_sweep</mat-icon>
          Vaciar carrito
        </button>
        <a mat-stroked-button color="primary" routerLink="/catalogo" class="h-10 flex items-center gap-2">
          <mat-icon>arrow_back</mat-icon>
          Seguir comprando
        </a>
      </div>
    </header>

    <div class="grid gap-6 xl:grid-cols-[2fr_1fr]">
      <!-- ========== LISTA DE PRODUCTOS ========== -->
      <section class="space-y-4" aria-label="Resumen de productos en el carrito">
        <ng-container *ngIf="cartItems.length; else emptyState">
          <mat-card *ngFor="let item of cartItems; trackBy: trackById" class="rounded-2xl shadow-sm border border-gray-100">
            <div class="flex flex-col gap-4 sm:flex-row">
              <div class="shrink-0 overflow-hidden rounded-xl sm:w-40 aspect-video">
                <img [src]="item.image" [alt]="item.name" class="h-full w-full object-cover" />
              </div>

              <div class="flex flex-1 flex-col gap-3">
                <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-2">
                  <div>
                    <h2 class="text-lg font-semibold text-gray-900">{{ item.name }}</h2>
                    <p class="text-sm text-blue-600 font-medium">{{ item.brand }}</p>
                    <p class="text-xs text-gray-500 mt-1">Compatibilidad: {{ item.compatibility }}</p>
                  </div>
                  <button mat-icon-button color="warn" class="-mr-2" (click)="removeItem(item.id)" aria-label="Eliminar">
                    <mat-icon>close</mat-icon>
                  </button>
                </div>

                <mat-divider></mat-divider>

                <div class="grid gap-4 sm:grid-cols-[1fr_auto] sm:items-center">
                  <div class="flex items-center gap-3">
                    <span class="text-xs uppercase tracking-wide text-gray-400">Cantidad</span>
                    <div class="flex items-center rounded-full border border-gray-200 bg-gray-50">
                      <button
                        mat-icon-button
                        type="button"
                        (click)="updateQuantity(item.id, -1)"
                        [disabled]="item.quantity <= 1"
                        class="h-9 w-9"
                        aria-label="Disminuir cantidad"
                      >
                        <mat-icon>remove</mat-icon>
                      </button>
                      <span class="w-10 text-center font-semibold">{{ item.quantity }}</span>
                      <button
                        mat-icon-button
                        type="button"
                        (click)="updateQuantity(item.id, 1)"
                        [disabled]="item.quantity >= item.stock"
                        class="h-9 w-9"
                        aria-label="Aumentar cantidad"
                      >
                        <mat-icon>add</mat-icon>
                      </button>
                    </div>
                    <span class="text-xs text-gray-500">{{ item.stock }} disponibles</span>
                  </div>

                  <!-- texto compacto para evitar saltos extra -->
                  <div class="text-right leading-tight">
                    <p class="text-sm text-gray-500">Precio unitario</p>
                    <p class="text-xl font-bold text-gray-900">
                      {{ item.price | currency : 'GTQ' : 'symbol-narrow' : '1.2-2' }}
                    </p>
                    <p class="text-xs text-gray-400 mt-1">
                      Subtotal: {{ (item.price * item.quantity) | currency : 'GTQ' : 'symbol-narrow' : '1.2-2' }}
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </mat-card>
        </ng-container>
      </section>

      <!-- ========== ASIDE: RESUMEN / ENVÍO / CUPÓN ========== -->
      <aside class="space-y-4" aria-label="Acciones del carrito">
        <!-- RESUMEN -->
        <mat-card class="rounded-2xl shadow-sm border border-gray-100">
          <mat-card-content class="space-y-4">
            <div class="flex items-baseline justify-between">
              <h2 class="text-lg font-semibold text-gray-900">Resumen</h2>
              <span class="text-sm text-gray-500">{{ totalUnits }} {{ totalUnits === 1 ? 'producto' : 'productos' }}</span>
            </div>

            <div class="space-y-3">
              <div class="flex items-center justify-between text-sm">
                <span>Subtotal</span>
                <span>{{ subtotal | currency : 'GTQ' : 'symbol-narrow' : '1.2-2' }}</span>
              </div>
              <div class="flex items-center justify-between text-sm" [class.text-green-600]="discount > 0">
                <span>Descuento</span>
                <span>-{{ discount | currency : 'GTQ' : 'symbol-narrow' : '1.2-2' }}</span>
              </div>
              <div class="flex items-center justify-between text-sm">
                <span>Envío</span>
                <span>{{ shippingCost | currency : 'GTQ' : 'symbol-narrow' : '1.2-2' }}</span>
              </div>
              <mat-divider></mat-divider>
              <div class="flex items-center justify-between text-lg font-bold text-gray-900">
                <span>Total</span>
                <span>{{ total | currency : 'GTQ' : 'symbol-narrow' : '1.2-2' }}</span>
              </div>
            </div>

            <button
              mat-flat-button
              color="primary"
              class="w-full h-12 text-base"
              [disabled]="!cartItems.length"
              (click)="proceedToCheckout()"
            >
              Proceder al pago
            </button>
          </mat-card-content>
        </mat-card>

        <!-- MÉTODO DE ENVÍO (sin solapes) -->
        <mat-card class="rounded-2xl shadow-sm border border-gray-100">
          <mat-card-content class="space-y-4">
            <h3 class="text-base font-semibold text-gray-900">Método de envío</h3>
            <div class="grid gap-2">
              <button
                mat-stroked-button
                *ngFor="let option of shippingOptions"
                class="w-full !p-0"
                [color]="option.id === selectedShipping.id ? 'primary' : undefined"
                [class.bg-blue-50]="option.id === selectedShipping.id"
                (click)="selectShipping(option)"
                type="button"
              >
                <span class="w-full flex items-start justify-between gap-3 py-3">
                  <span class="text-left leading-tight">
                    <span class="block font-medium">{{ option.label }}</span>
                    <span class="block text-xs text-gray-500">{{ option.description }}</span>
                  </span>
                  <span class="font-semibold whitespace-nowrap">
                    {{ option.cost | currency : 'GTQ' : 'symbol-narrow' : '1.2-2' }}
                  </span>
                </span>
              </button>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- CUPÓN -->
        <mat-card class="rounded-2xl shadow-sm border border-gray-100">
          <mat-card-content class="space-y-3">
            <h3 class="text-base font-semibold text-gray-900">Cupón de descuento</h3>
            <mat-form-field appearance="outline" class="w-full">
              <mat-label>Código promocional</mat-label>
              <input matInput [(ngModel)]="couponCode" placeholder="AHORRA10" />
            </mat-form-field>
            <div class="flex gap-2">
              <button mat-stroked-button color="primary" class="flex-1" type="button" (click)="applyCoupon()">
                Aplicar
              </button>
              <button mat-button type="button" class="flex-1" (click)="couponCode = ''">
                Limpiar
              </button>
            </div>
            <p class="text-sm" [class.text-green-600]="couponSuccess" [class.text-red-500]="!couponSuccess">
              {{ couponMessage }}
            </p>
          </mat-card-content>
        </mat-card>
      </aside>
    </div>
  </ng-container>

  <!-- ================== FORMULARIO DE PAGO ================== -->
  <ng-container *ngIf="showPaymentForm">
    <div class="max-w-2xl mx-auto">
      <div class="mb-6">
        <button mat-icon-button (click)="cancelPayment()" class="mb-4">
          <mat-icon>arrow_back</mat-icon>
        </button>
        <h1 class="text-3xl font-bold text-gray-900">Completar pago</h1>
        <p class="text-gray-500 mt-1">Ingresa tus datos de facturación y tarjeta de crédito</p>
      </div>

      <form [formGroup]="paymentForm" class="space-y-6">
        <!-- FACTURACIÓN -->
        <mat-card class="rounded-2xl shadow-sm border border-gray-100">
          <mat-card-header class="bg-gray-50 border-b">
            <mat-card-title class="text-lg font-semibold text-gray-900 flex items-center gap-2">
              <mat-icon class="text-blue-600">location_on</mat-icon>
              Datos de facturación
            </mat-card-title>
          </mat-card-header>
          <mat-card-content class="pt-6 grid gap-4 sm:grid-cols-2">
            <mat-form-field appearance="outline" class="w-full">
              <mat-label>Nombre completo</mat-label>
              <input matInput formControlName="fullName" placeholder="Juan Pérez" />
              <mat-error *ngIf="paymentForm.get('fullName')?.touched">
                {{ getErrorMessage('fullName') }}
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="w-full">
              <mat-label>Email</mat-label>
              <input matInput formControlName="email" placeholder="correo@ejemplo.com" type="email" />
              <mat-error *ngIf="paymentForm.get('email')?.touched">
                {{ getErrorMessage('email') }}
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="w-full">
              <mat-label>Teléfono</mat-label>
              <input matInput formControlName="phone" placeholder="12345678" maxlength="8" />
              <mat-hint>8 dígitos</mat-hint>
              <mat-error *ngIf="paymentForm.get('phone')?.touched">
                {{ getErrorMessage('phone') }}
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="w-full">
              <mat-label>Ciudad</mat-label>
              <input matInput formControlName="city" placeholder="Guatemala" />
              <mat-error *ngIf="paymentForm.get('city')?.touched">
                {{ getErrorMessage('city') }}
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="w-full sm:col-span-2">
              <mat-label>Dirección</mat-label>
              <input matInput formControlName="address" placeholder="Calle Principal 123, Apartamento 4B" />
              <mat-error *ngIf="paymentForm.get('address')?.touched">
                {{ getErrorMessage('address') }}
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="w-full">
              <mat-label>Código postal</mat-label>
              <input matInput formControlName="postalCode" placeholder="01001" maxlength="5" />
              <mat-hint>5 dígitos</mat-hint>
              <mat-error *ngIf="paymentForm.get('postalCode')?.touched">
                {{ getErrorMessage('postalCode') }}
              </mat-error>
            </mat-form-field>
          </mat-card-content>
        </mat-card>

        <!-- TARJETA -->
        <mat-card class="rounded-2xl shadow-sm border border-gray-100">
          <mat-card-header class="bg-gray-50 border-b">
            <mat-card-title class="text-lg font-semibold text-gray-900 flex items-center gap-2">
              <mat-icon class="text-blue-600">credit_card</mat-icon>
              Datos de tarjeta de crédito
            </mat-card-title>
          </mat-card-header>
          <mat-card-content class="pt-6 grid gap-4 sm:grid-cols-2">
            <mat-form-field appearance="outline" class="w-full sm:col-span-2">
              <mat-label>Titular de la tarjeta</mat-label>
              <input matInput formControlName="cardName" placeholder="JUAN PEREZ" />
              <mat-error *ngIf="paymentForm.get('cardName')?.touched">
                {{ getErrorMessage('cardName') }}
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="w-full sm:col-span-2">
              <mat-label>Número de tarjeta</mat-label>
              <input matInput formControlName="cardNumber" placeholder="1234 5678 9012 3456" maxlength="16" />
              <mat-hint>16 dígitos</mat-hint>
              <mat-error *ngIf="paymentForm.get('cardNumber')?.touched">
                {{ getErrorMessage('cardNumber') }}
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="w-full">
              <mat-label>Fecha de vencimiento</mat-label>
              <input matInput formControlName="expiryDate" placeholder="MM/AA" maxlength="5" />
              <mat-hint>MM/AA</mat-hint>
              <mat-error *ngIf="paymentForm.get('expiryDate')?.touched">
                {{ getErrorMessage('expiryDate') }}
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="w-full">
              <mat-label>CVV</mat-label>
              <input matInput formControlName="cvv" placeholder="123" maxlength="3" type="password" />
              <mat-hint>3 dígitos</mat-hint>
              <mat-error *ngIf="paymentForm.get('cvv')?.touched">
                {{ getErrorMessage('cvv') }}
              </mat-error>
            </mat-form-field>
          </mat-card-content>
        </mat-card>

        <!-- RESUMEN PAGO -->
        <mat-card class="rounded-2xl shadow-sm border border-gray-100 bg-blue-50">
          <mat-card-content class="space-y-3 pt-6">
            <h3 class="text-lg font-semibold text-gray-900">Resumen del pedido</h3>
            <div class="space-y-2 text-sm">
              <div class="flex justify-between">
                <span class="text-gray-600">{{ totalUnits }} producto(s)</span>
                <span class="font-medium">{{ subtotal | currency : 'GTQ' : 'symbol-narrow' : '1.2-2' }}</span>
              </div>
              <div class="flex justify-between" *ngIf="discount > 0">
                <span>Descuento</span>
                <span>-{{ discount | currency : 'GTQ' : 'symbol-narrow' : '1.2-2' }}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">Envío ({{ selectedShipping.label }})</span>
                <span class="font-medium">{{ shippingCost | currency : 'GTQ' : 'symbol-narrow' : '1.2-2' }}</span>
              </div>
              <mat-divider class="my-2"></mat-divider>
              <div class="flex justify-between text-lg font-bold text-gray-900">
                <span>Total a pagar</span>
                <span class="text-blue-600">{{ total | currency : 'GTQ' : 'symbol-narrow' : '1.2-2' }}</span>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- ACCIONES -->
        <div class="flex gap-3">
          <button mat-stroked-button class="flex-1 h-12 text-base" (click)="cancelPayment()" type="button">
            <mat-icon class="mr-2">close</mat-icon>
            Cancelar
          </button>
          <button
            mat-flat-button
            color="primary"
            class="flex-1 h-12 text-base"
            [disabled]="paymentForm.invalid"
            (click)="submitPayment()"
            type="button"
          >
            <mat-icon class="mr-2">check_circle</mat-icon>
            Procesar pago
          </button>
        </div>
      </form>
    </div>
  </ng-container>

  <!-- ================== CARRITO VACÍO ================== -->
  <ng-template #emptyState>
    <mat-card class="rounded-2xl border border-dashed border-gray-200 bg-gray-50">
      <mat-card-content class="flex flex-col items-center gap-4 py-12">
        <!-- usar set baseline para evitar el “cl” -->
        <mat-icon class="text-4xl text-gray-400">shopping_cart</mat-icon>
        <div class="text-center space-y-2">
          <h2 class="text-xl font-semibold text-gray-900">Tu carrito está vacío</h2>
          <p class="text-sm text-gray-500">Explora el catálogo y agrega repuestos para continuar con la compra.</p>
        </div>
        <a mat-flat-button color="primary" routerLink="/catalogo">Ir al catálogo</a>
      </mat-card-content>
    </mat-card>
  </ng-template>
</div>

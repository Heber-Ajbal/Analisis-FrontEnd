<mat-toolbar class="toolbar luxe">
  <div class="brand">
    <mat-icon>inventory_2</mat-icon>
    <div class="brand-col">
      <span class="title">Inventario</span>
      <span class="hint">Portal admin</span>
    </div>
  </div>

  <span class="spacer"></span>

  <div class="toolbar-actions">
    <div class="toolbar-search">
      <mat-form-field appearance="outline" class="field xs-hide">
        <mat-label>Buscar</mat-label>
        <mat-icon matPrefix>search</mat-icon>
        <input
          matInput
          placeholder="SKU, nombre, proveedor…"
          [value]="q()"
          (input)="q.set($any($event.target).value)"
        />
        <button *ngIf="q()" matSuffix mat-icon-button aria-label="Clear" (click)="q.set('')">
          <mat-icon>close</mat-icon>
        </button>
      </mat-form-field>
    </div>

    <button mat-flat-button color="primary" class="pill" (click)="openNew()">
      <mat-icon>add</mat-icon><span>Nuevo</span>
    </button>
  </div>
</mat-toolbar>

<div class="page">
  <!-- Filtros -->
  <mat-card class="card filters">
    <div class="filters-grid">
      <mat-form-field appearance="fill" class="field sm-only">
        <mat-label>Buscar</mat-label>
        <mat-icon matPrefix>search</mat-icon>
        <input
          matInput
          placeholder="SKU, nombre, proveedor…"
          [value]="q()"
          (input)="q.set($any($event.target).value)"
        />
        <button *ngIf="q()" matSuffix mat-icon-button aria-label="Clear" (click)="q.set('')">
          <mat-icon>close</mat-icon>
        </button>
      </mat-form-field>

      <mat-form-field appearance="fill" class="field w-200">
        <mat-label>Categoría</mat-label>
        <mat-icon matPrefix>category</mat-icon>
        <mat-select [value]="categoria()" (selectionChange)="categoria.set($event.value)">
          <mat-option [value]="null">Todas</mat-option>
          <mat-option *ngFor="let c of categorias()" [value]="c">{{ c }}</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="fill" class="field w-160">
        <mat-label>Estado</mat-label>
        <mat-icon matPrefix>offline_pin</mat-icon>
        <mat-select [value]="estado()" (selectionChange)="estado.set($event.value)">
          <mat-option [value]="null">Todos</mat-option>
          <mat-option value="activo">Activo</mat-option>
          <mat-option value="inactivo">Inactivo</mat-option>
          <mat-option value="bajo-stock">Bajo stock</mat-option>
        </mat-select>
      </mat-form-field>

      <button mat-stroked-button class="field w-140" (click)="resetFilters()" aria-label="Limpiar filtros">
        <mat-icon>filter_alt_off</mat-icon>Limpiar
      </button>
    </div>

    <div class="chips">
      <mat-chip-set>
        <mat-chip *ngIf="q()" class="chip" (removed)="q.set('')">
          <mat-icon>search</mat-icon> {{ q() }} <mat-icon matChipRemove>cancel</mat-icon>
        </mat-chip>
        <mat-chip *ngIf="categoria()" class="chip" (removed)="categoria.set(null)">
          <mat-icon>category</mat-icon> {{ categoria() }} <mat-icon matChipRemove>cancel</mat-icon>
        </mat-chip>
        <mat-chip *ngIf="estado()" class="chip" (removed)="estado.set(null)">
          <mat-icon>offline_pin</mat-icon> {{ estado() }} <mat-icon matChipRemove>cancel</mat-icon>
        </mat-chip>
      </mat-chip-set>
    </div>
  </mat-card>

  <!-- Tabla -->
  <mat-card class="card table-card">
    <!-- loading bar -->
    <mat-progress-bar *ngIf="loading()" mode="indeterminate"></mat-progress-bar>

    <div class="table-wrap">
      <!-- Estado vacío -->
      <div *ngIf="!loading() && rows().length === 0" class="table-empty">
        <mat-icon>inventory</mat-icon>
        <p>No hay productos que coincidan con los filtros.</p>
        <button mat-stroked-button (click)="resetFilters()">
          <mat-icon>refresh</mat-icon> Restablecer filtros
        </button>
      </div>

      <!-- Tabla -->
      <table
        *ngIf="rows().length > 0 || loading()"
        mat-table
        [dataSource]="rows()"
        class="mat-elevation-z2 luxe-table"
      >
        <!-- SKU -->
        <ng-container matColumnDef="sku">
          <th mat-header-cell *matHeaderCellDef class="th-mono">SKU</th>
          <td mat-cell *matCellDef="let e">
            <span class="mono sku-badge">{{ e.sku }}</span>
          </td>
        </ng-container>

        <!-- Producto -->
        <ng-container matColumnDef="nombre">
          <th mat-header-cell *matHeaderCellDef>Producto</th>
          <td mat-cell *matCellDef="let e">
            <div class="prod">
              <div class="thumb" [class.skeleton]="loading()">
                <img *ngIf="e.imagenUrl && !loading()" [src]="e.imagenUrl" alt="" />
              </div>
              <div class="col">
                <div class="p-name" [class.skeleton]="loading()">{{ e.nombre }}</div>
                <div class="p-meta" [class.skeleton]="loading()">
                  {{ e.categoria }} • {{ e.proveedor || '—' }}
                </div>
              </div>
            </div>
          </td>
        </ng-container>

        <!-- Precio -->
        <ng-container matColumnDef="precio">
          <th mat-header-cell *matHeaderCellDef>Precio</th>
          <td mat-cell *matCellDef="let e" class="price">
            <span [class.skeleton]="loading()">{{ e.precio | currency:'Q' }}</span>
          </td>
        </ng-container>

        <!-- Stock -->
        <ng-container matColumnDef="stock">
          <th mat-header-cell *matHeaderCellDef>Stock</th>
          <td mat-cell *matCellDef="let e">
            <div class="stock">
              <div class="stock-row">
                <span class="strong" [class.low]="e.stock <= e.minimo">{{ e.stock }}</span>
                <span class="min">/ min {{ e.minimo }}</span>
              </div>
              <div class="stock-bar" [attr.data-status]="statusFor(e)">
                <div class="fill" [style.width.%]="stockPct(e)"></div>
              </div>
            </div>
          </td>
        </ng-container>

        <!-- Estado -->
        <ng-container matColumnDef="estado">
          <th mat-header-cell *matHeaderCellDef>Estado</th>
          <td mat-cell *matCellDef="let e">
            <span class="badge" [ngClass]="badgeClass(e)">
              {{ e.estado | titlecase }}
            </span>
          </td>
        </ng-container>

        <!-- Acciones -->
        <ng-container matColumnDef="acciones">
          <th mat-header-cell *matHeaderCellDef class="th-center">Acciones</th>
          <td mat-cell *matCellDef="let e" class="actions">
            <button mat-icon-button [matMenuTriggerFor]="rowMenu" aria-label="Acciones" matTooltip="Acciones">
              <mat-icon>more_vert</mat-icon>
            </button>
            <mat-menu #rowMenu="matMenu">
              <button mat-menu-item (click)="openEdit(e)">
                <mat-icon>edit</mat-icon><span>Editar</span>
              </button>
              <button mat-menu-item (click)="openMoves(e)">
                <mat-icon>history</mat-icon><span>Movimientos</span>
              </button>
            </mat-menu>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns" class="sticky"></tr>

        <!-- Fila normal -->
        <tr
          mat-row
          *matRowDef="let row; columns: displayedColumns"
          class="row"
          [class.loading-row]="loading()"
        ></tr>

        <!-- Filas “skeleton” (mientras carga) -->
        <ng-container *ngIf="loading()">
          <tr class="row skeleton-row" *ngFor="let sk of skeletonRows">
            <td class="cell skeleton"></td>
            <td class="cell skeleton"></td>
            <td class="cell skeleton"></td>
            <td class="cell skeleton"></td>
            <td class="cell skeleton"></td>
            <td class="cell skeleton"></td>
          </tr>
        </ng-container>
      </table>
    </div>

    <mat-divider></mat-divider>

    <div class="table-footer">
      <div class="muted">Total: {{ total() | number }}</div>
      <mat-paginator
        [pageIndex]="page() - 1"
        [pageSize]="pageSize()"
        [length]="total()"
        [pageSizeOptions]="[10, 25, 50]"
        (page)="onPage($event)"
        aria-label="Paginación"
      ></mat-paginator>
    </div>
  </mat-card>
</div>
